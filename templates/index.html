<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Leve Profits Explorer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #00bcd4;
        --primary-dark: #0097a7;
        --bg: #f9f9f9;
        --text: #333;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: "Poppins", sans-serif;
        background-color: var(--bg);
        color: var(--text);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        text-align: center;
        margin-bottom: 30px;
      }
      header h1 {
        font-weight: 600;
        color: var(--primary-dark);
        margin: 0;
      }
      .controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 20px;
      }
      .controls label {
        font-weight: 500;
      }
      .controls select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: #fff;
        transition: border-color 0.3s;
      }
      .controls select:focus {
        border-color: var(--primary);
        outline: none;
      }
      .table-wrapper {
        display: flex;
        justify-content: center;
      }
      table {
        width: auto;
        max-width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 0;
      }
      th,
      td {
        padding: 12px 15px;
        text-align: left;
      }
      th {
        background: var(--primary);
        color: #fff;
        cursor: pointer;
        user-select: none;
        transition: background 0.3s;
        position: relative;
      }
      th:hover {
        background: var(--primary-dark);
      }
      th.sort-asc::after {
        content: " ▲";
      }
      th.sort-desc::after {
        content: " ▼";
      }
      tr:nth-child(even) {
        background: #f2f2f2;
      }
      tr:hover {
        background: #e0f7fa;
      }
      .error {
        color: #e53935;
        text-align: center;
        margin-top: 20px;
      }
      .empty {
        text-align: center;
        color: #777;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Leve Profits Explorer</h1>
      </header>
      <div class="controls">
        <label>
          World:
          <select id="worldSelect">
            <option value="">– select –</option>
            {% for w in worlds %}
            <option value="{{ w }}">{{ w }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Job:
          <select id="jobSelect" disabled>
            <option value="">– select –</option>
            {% for j in jobs %}
            <option value="{{ j }}">{{ j }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="table-wrapper" id="tableContainer"></div>
    </div>
    <script>
      const worldEl = document.getElementById("worldSelect");
      const jobEl = document.getElementById("jobSelect");
      const container = document.getElementById("tableContainer");

      const columnOrder = [
        "Leve Level",
        "Leve Name",
        "Leve Item",
        "Leve Amount",
        "Leve EXP",
        "Leve Gil",
        "currentAveragePrice",
        "currentAveragePriceHQ",
        "currentAveragePriceNQ",
        "LevePriceNQ",
        "LeveProfitNQ",
        "LevePriceHQ",
        "LeveProfitHQ",
      ];
      const aliasMap = {
        "Leve Name": "Name",
        "Leve Level": "Level",
        "Leve Amount": "Amount",
        "Leve EXP": "EXP",
        "Leve Gil": "Gil",
        LevePriceHQ: "Market Price (HQ)",
        LeveProfitHQ: "Profit (HQ)",
        LevePriceNQ: "Market Price (NQ)",
        LeveProfitNQ: "Profit (NQ)",
        "Leve Item": "Required Item",
        "Leve Item ID": "Item ID",
        currentAveragePrice: "Avg. Price (All)",
        currentAveragePriceHQ: "Avg. Price (HQ)",
        currentAveragePriceNQ: "Avg. Price (NQ)",
      };

      let currentData = [];
      let sortKey = null;
      let sortAsc = true;

      function clearTable() {
        container.innerHTML = "";
        sortKey = null;
      }

      function renderTable(data) {
        if (!data.length) {
          container.innerHTML = '<div class="empty">No records found.</div>';
          return;
        }

        const actualKeys = Object.keys(data[0]);
        const cols = columnOrder.filter((key) => actualKeys.includes(key));

        let html = "<table><thead><tr>";
        for (let key of cols) {
          const label = aliasMap[key] || key;
          html += `<th data-key="${key}">${label}</th>`;
        }
        html += "</tr></thead><tbody>";

        for (let row of data) {
          html += "<tr>";
          for (let key of cols) {
            const raw = row[key];
            const baseVal = raw === "" || raw == null ? 0 : raw;
            const num = parseFloat(baseVal);
            const display = !isNaN(num) ? Math.round(num) : baseVal;
            html += `<td>${display}</td>`;
          }
          html += "</tr>";
        }

        html += "</tbody></table>";
        container.innerHTML = html;

        container.querySelectorAll("th").forEach((th) => {
          const key = th.dataset.key;
          th.classList.toggle("sort-asc", key === sortKey && sortAsc);
          th.classList.toggle("sort-desc", key === sortKey && !sortAsc);

          th.addEventListener("click", () => {
            if (sortKey === key) {
              sortAsc = !sortAsc;
            } else {
              sortKey = key;
              sortAsc = true;
            }
            currentData.sort((a, b) => {
              let aRaw = a[key],
                bRaw = b[key];
              const blankA = aRaw == null || aRaw === "";
              const blankB = bRaw == null || bRaw === "";
              const numA = blankA ? 0 : parseFloat(aRaw);
              const numB = blankB ? 0 : parseFloat(bRaw);

              if (!isNaN(numA) && !isNaN(numB)) {
                return sortAsc ? numA - numB : numB - numA;
              }
              const strA = String(blankA ? 0 : aRaw);
              const strB = String(blankB ? 0 : bRaw);
              return sortAsc
                ? strA.localeCompare(strB)
                : strB.localeCompare(strA);
            });
            renderTable(currentData);
          });
        });
      }

      function fetchAndShow() {
        const world = worldEl.value,
          job = jobEl.value;
        if (!world || !job) {
          clearTable();
          return;
        }
        fetch(
          `/data?world=${encodeURIComponent(world)}&job=${encodeURIComponent(
            job
          )}`
        )
          .then((r) => (r.ok ? r.json() : Promise.reject(r.statusText)))
          .then((data) => {
            currentData = data;
            renderTable(currentData);
          })
          .catch((err) => {
            clearTable();
            container.innerHTML = `<div class="error">Error: ${err}</div>`;
          });
      }
      function handleSelectChange() {
        // enable/disable job dropdown based on world
        jobEl.disabled = !worldEl.value;
        // if both are selected, fetch; otherwise clear
        if (worldEl.value && jobEl.value) {
          fetchAndShow();
        } else {
          clearTable();
        }
      }

      worldEl.addEventListener("change", handleSelectChange);
      jobEl.addEventListener("change", handleSelectChange);

      worldEl.addEventListener("change", () => {
        jobEl.disabled = !worldEl.value;
        clearTable();
      });
      jobEl.addEventListener("change", fetchAndShow);
    </script>
  </body>
</html>
